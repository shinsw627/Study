# 네트워크 전체 흐름 간단하게 정리

\***\*총정리 네트워크 전체의 흐름
NetworkingBeginner Mar 23, 2020**

네트워크의 전체적인 흐름을 살펴보면서 지금까지의 모든 내용을 정리해보자.

# **Google에 접속하기 까지**

Google 홈페이지 접속을 예로 네트워크의 전체적인 흐름을 정리해 보자. 생략되거나 간소화된 부분도 많지만 이용자에게 웹페이지가 도달되기까지는 다음 사진과 같은 과정을 거친다.

![https://lamarr.dev/images/basicnetworking/network-049.jpg](https://lamarr.dev/images/basicnetworking/network-049.jpg)

# **이용자의 통신 요청 + 사전준비**

이용자는 웹 브라우저(크롬,사파리)에 `HTTPS 프로토콜`과 구글의 도메인 주소(https://www.google.com/)를 입력해서 통신을 요청한다. 이 과정은 L7 Application Layer에서 시작된다.

DNS서버에게 도메인 주소 google.com의 IP주소 172.217.27.78을 받아온다.

https는 TCP 프로토콜을 사용한다. 따라서 데이터를 보내기 전에 유저의 컴퓨터와 구글 서버는 `3-way-handshake` 를 수행하고 커넥션(connection)을 확립한다.

# **이용자 데이터의 캡슐화**

커넥션이 확립되면 유저는 구글 서버(https://172.217.27.78)에 웹페이지를 요청하는 데이터를 보낸다. 데이터는 파란색 화살표 방향으로 L7부터 L1까지 각 계층마다 사용되는 프로토콜의 헤더가 붙으며 `캡슐화`된다. 데이터에 가장 붙는 헤더는 L7 Application Layer의 `HTTPS`가 된다.

Layer6, Layer5에서도 차례대로 헤더가 붙고 다음 L4 Transport Layer에서 `TCP 헤더`가 붙는다. TCP 프로토콜은 신뢰할 수 있고 정확한 데이터 송신을 위해 사용되고 출발지 포트번호와 목적지 포트번호가 기록된다. 여기 까지의 데이터를 `세그먼트(Segment)`라고 한다.

L3 Network Layer 에서는 `IP 프로토콜`의 헤더가 붙는다. 헤더에는 `출발지 IP주소`와 `목적지 IP주소`가 기록된다. 이렇게 구성된 데이터를 `패킷(Packet)`이라고 한다.

L2 Data Link Layer에서는 `Ethernet`의 헤더가 붙는다. 헤더에는 목적지로 가기위해 거쳐야할 IP주소를 가지고 있는 장비 즉 `라우터의 MAC주소`가 기록된다. 이 데이터를 `프레임(Frame)`이라고 한다.

L1 Physical Layer의 `랜카드` 라는 장비를 거쳐 데이터는 전기신호로 변환된다. 그리고 `케이블(UTP)`로 물리적으로 연결 되어 있는 `스위치(Switch)`라는 장비로 향한다. 위 그림의 남자아이의 컴퓨터와 스위치가 보라색 선으로 연결 되있는 부분이다.

# **스위치에 도착한 데이터**

스위치에 도착한 데이터는 L1, L2 순으로 `역캡슐화`가 이루어진다. 스위치는 L2(이더넷)헤더에서 `목적지의 MAC 주소` 를 알아내고 `MAC 주소 테이블`을 참고하여 어느 포트로 내보내야 할지를 조사한다. 그리고 다시 데이터를 캡슐화해서 전기신호로 다음 목적지인 라우터로 전송한다.

# **라우터에 도착한 데이터**

라우터는 전기신호로 도착한 데이터를 우선 L2 헤더까지 역캡슐화한다. 목적지 MAC주소와 자신의 MAC주소가 같으면 L3의 헤더까지 역캡슐화를 수행하고 자신의 `라우팅 테이블`과 목적지 IP주소를 비교한다. 자신의 라우팅 테이블에서 목적지 IP까지의 경로를 알수 있으면 라우팅을 진행한다. 이 때 만약 출발지 IP가 `사설 IP`일 경우 L3 IP헤더에서 출발지 IP주소를 라우터의 `공인 IP`주소로 설정한다. 다음으로 이더넷 헤더에서 라우팅으로 알아낸 다음 목적지 MAC주소를 수정하고 데이터를 다시 캡슐화해서 다음 경로로 보낸다.

그림에서는 두개의 라우터만을 거치지만, 실제로는 여러 라우터를 거치며 목적지까지 역캡슐화와 캡슐화의 과정을 반복한다.

마지막 라우터는 라우팅 테이블을 통해 목적지 IP주소까지의 경로를 알수 있다. L3헤더에서 출발지 IP주소를 자신의 라우터 내부 IP주소로 변경하고, L2(이더넷)헤더에서는 스위치에 전달되도록 MAC주소를 수정한다. 다시 캡슐화를하고 전기신호를 연결되어있는 스위치로 전달한다.

# **서버(목적지)측의 데이터 처리**

스위치는 역캡슐화와 캡슐화를 진행하고 데이터를 구글 서버에 전기신호로 전달한다.

구글서버는 이용자가 보낸 웹페이지를 요청하는 데이터를 Layer7부터 Layer1까지 역캡슐화 한다.

먼저 L2에서 이더넷 프레임의 목적지 MAC주소와 자신의 주소를 비교 한다. 주소가 같으면 L2헤더와 트레일러를 분리하고 L3 Network Layer에 전달한다.

L3 Network Layer에서는 목적지 IP주소와 웹 서버의 IP주소가 같은지 확인한다. 같으면 IP헤더를 분리하고 L4 Transport Layer에 전달한다.

L4 Transport Layer에서는 목적지 포트 번호를 확인하여 어떤 어플리케이션으로 전달할지 정한다. 만약 데이터에 오류가 있다면 송신측(이용자 컴퓨터)에게 데이터 재전송을 요청한다. 오류가 없다면 TCP헤더를 분리하고 L5 Session Layer로 전달한다.

L5, L6을 거쳐 L7 Application Layer로 데이터가 도착한다. 구글 서버는 이 데이터에 문제가 없으면 승인을 하고 빨간색 화살표 방향으로 웹페이지의 데이터를 이용자에게 보내준다.

[총정리 네트워크 전체의 흐름 by NetworkingBeginner](https://lamarr.dev/networkingbeginner/2020/03/23/13.html)
